function initCapitaSpringOverrides(){dojo.declare("Capita.RemotingHandler",[Spring.RemotingHandler],{handleResponse:function(response,ioArgs){var superHandler=new Spring.RemotingHandler();response=superHandler.handleResponse(response,ioArgs);$(document).trigger("updateCurrentCSRFNonce",ioArgs.xhr);var redirectURL=ioArgs.xhr.getResponseHeader("Spring-Redirect-URL");if(!(dojo.isString(redirectURL)&&redirectURL.length>0)){$(document).trigger("handleSpringResponse");}
return response;},handleError:function(response,ioArgs){if(window.console){console.error("HTTP status code: ",ioArgs.xhr.status);}
if(Spring.debug&&ioArgs.xhr.status!=200){Spring.remoting.showError(ioArgs.xhr.responseText);}
return response;},showError:function(message){$(document).trigger("handleSpringErrorResponse",[message]);},_renderURLToModalDialog:function(url){Spring.remoting.getResource(url,{},true);},_renderResponseToModalDialog:function(response){$(document).trigger("handleSpringResponseInModal",[response]);}});Spring.remoting=new Capita.RemotingHandler();}
dojo.addOnLoad(initCapitaSpringOverrides);(function($){var currentCSRFNonce=false;$(document).unbind("updateCurrentCSRFNonce").bind("updateCurrentCSRFNonce",function(event,xhr){currentCSRFNonce=xhr.getResponseHeader("CSRF-Nonce");});$.widget("capita.ajaxwebflow",{options:{prefix:"cwf",defaultFragment:"body",blockUiStartMillis:250,blockUiTimeoutMillis:30000,csrfNonceParam:"org.apache.catalina.filters.CSRF_NONCE"},_create:function(){var self=this;if(self.element.is("a")||self.element.is("input:submit")){if(self.element.is("a")){var href=self.element.attr("href");if(!href||href.length<=0||href=="#"){return;}}}else{return;}
var classAttr=self.element.attr("class");if(classAttr){var classArray=classAttr.split(" ");self.fragments=new Array();for(var i=0;i<classArray.length;i++){if(classArray[i]==(self.options.prefix+"-validate")){self.validate=true;}else if(classArray[i]==(self.options.prefix+"-ajax")){self.ajax=true;}else if(classArray[i]==(self.options.prefix+"-opennewpopup")){self.opennewpopup=true;}else if(classArray[i]===(self.options.prefix+"-usepopup")){self.usepopup=true;}else if(classArray[i]==(self.options.prefix+"-removetablerow")){self.removetablerow=true;}else if(classArray[i].indexOf(self.options.prefix+"-fragment-")==0){var fragment=classArray[i].replace(self.options.prefix+"-fragment-","");self.fragments.push(fragment);}}}
self.element.bind("click",function(event){return self._handleClickEvent();});},_handleClickEvent:function(){var self=this;if(self.validate){if(!self._validateForm()){$.dialogmanager.redrawTopDialog();return false;}}
if($.fn.block){$.blockUI({message:null,fadeIn:0,overlayCSS:{backgroundColor:'#fff',opacity:0.0}});self.blockUiStartTimeout=setTimeout(function(){$.blockUI();setTimeout($.unblockUI,self.options.blockUiTimeoutMillis);},self.options.blockUiStartMillis);}
self._updateCSRFNonce();if(self.removetablerow){self._removeTableRow();return false;}else if(self.ajax||self.opennewpopup||self.usepopup){$(document).unbind("handleSpringResponse").bind("handleSpringResponse",function(){self._handleResponse();});$(document).unbind("handleSpringErrorResponse").bind("handleSpringErrorResponse",function(event,responseText){self._handleErrorResponse(responseText);});if(self.ajax&&self.element.is("input:submit")){Spring.remoting.submitForm(self.element.attr("id"),self.element.closest("form").attr("id"),{fragments:self._createFragmentString()});}else if(self.opennewpopup||self.usepopup){$(document).unbind("handleSpringResponseInModal").bind("handleSpringResponseInModal",function(event,responseText){self._handleSpringResponseInModal(responseText);});Spring.remoting.getLinkedResource(self.element.attr("id"),{fragments:self.options.defaultFragment},true);}else{Spring.remoting.getLinkedResource(self.element.attr("id"),{fragments:self._createFragmentString()},false);}
return false;}
return true;},_validateForm:function(){var self=this;var formName=self.element.closest("form").attr("id");$("#"+formName).find("ul.error").remove();$("#"+formName).find(".error:not(#pageErrors)").removeClass("error");var validator=obsvalidator[formName]();return validator.form();},_updateCSRFNonce:function(){var self=this;if(!currentCSRFNonce)return;var url=self.element.is("a")?self.element.attr("href"):self.element.closest("form").attr("action");var regExp=new RegExp(self.options.csrfNonceParam+"=[0-9,A-F]+");var newurl=url.replace(regExp,self.options.csrfNonceParam+"="+currentCSRFNonce);self.element.is("a")?self.element.attr("href",newurl):self.element.closest("form").attr("action",newurl);},_createFragmentString:function(){var self=this;var fragments=self.fragments.toString();if(!fragments||fragments.length<=0){fragments=self.options.defaultFragment;}
return fragments;},_handleResponse:function(){var self=this;setupWebflowExtension();setupTypeOfBooking();setupTestCentreGroup();setupHelpToolTip();$("body").append("<span style='display:none'>Page updated: "+new Date()+"</span>");$.dialogmanager.redrawTopDialog();if($.fn.block){clearTimeout(self.blockUiStartTimeout);$.unblockUI();}},_handleErrorResponse:function(content){var self=this;$("body").append("<span style='display:none'>Page updated: "+new Date()+"</span>");self._handleSpringResponseInModal(content);if($.fn.block){clearTimeout(self.blockUiStartTimeout);$.unblockUI();}},_handleSpringResponseInModal:function(content){var self=this;var modaldialog=$.dialogmanager.getTopStackedDialog();if(modaldialog==null||self.opennewpopup){modaldialog=$.dialogmanager.createStackedDialog();}
modaldialog.dialog("setContent",content);modaldialog.dialog("open");},_removeTableRow:function(){var self=this;$.ajax({url:self.element.attr("href"),success:function(response){self.element.closest("tr").fadeOut('slow',function(){var rows=self.element.closest("table").find("tr:visible");rows.removeClass("even");rows.filter(":even").addClass("even");self._handleResponse();});},complete:function(jqXHR){$(document).trigger("updateCurrentCSRFNonce",jqXHR);}});}});})(jQuery);